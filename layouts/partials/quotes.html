{{ $quotesFile := "data/quotes.txt" }}
{{ $quotes := slice }}

{{ if fileExists $quotesFile }}
  {{ $content := readFile $quotesFile }}
  {{ $lines := split $content "\n" }}
  {{ range $lines }}
    {{ $line := strings.TrimSpace . }}
    {{ if and $line (not (hasPrefix $line "#")) }}
      {{ $parts := split $line "|" }}
      {{ if ge (len $parts) 2 }}
        {{ $quote := dict "text" (index $parts 0) "author" (index $parts 1) }}
        {{ if eq (len $parts) 3 }}
          {{ $quote = merge $quote (dict "translation" (index $parts 2)) }}
        {{ end }}
        {{ $quotes = $quotes | append $quote }}
      {{ end }}
    {{ end }}
  {{ end }}
{{ end }}

<div class="quotes-widget" id="quotes-widget">
  <div class="quote-content">
    {{ if $quotes }}
      {{ $selectedQuote := index $quotes (mod now.Unix (len $quotes)) }}
      <blockquote class="quote-text">{{ $selectedQuote.text | replaceRE "--" "<br>" | safeHTML }}</blockquote>
      <cite class="quote-author">— {{ $selectedQuote.author }}</cite>
      {{ if $selectedQuote.translation }}
        <div class="translation">{{ $selectedQuote.translation }}</div>
      {{ end }}
    {{ else }}
      <blockquote class="quote-text">The only true wisdom is in knowing you know nothing.</blockquote>
      <cite class="quote-author">— Socrates</cite>
    {{ end }}
  </div>
  <button id="prev-quote" class="quote-btn"><<</button>
  <button id="next-quote" class="quote-btn">>></button>
</div>

<style>

.quotes-widget {
  background: var(--color-background-code);
  color: var(--color-text);
  border: 1px solid var(--color-border);
  border-radius: 12px;
  padding: 24px;
  margin: 24px 0;
  text-align: center;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.quotes-widget h3 {
  margin-top: 0;
  font-size: 1.2em;
  color: var(--color-accent-1);
}

.quote-content {
    margin: 20px 0;
}

.quote-text::before,
.quote-text::after {
  content: none !important;
  display: none !important;
}

.quote-text {
  font-size: 14px;
  font-style: normal;
  margin: 0 0 12px 0;
  padding: 0;
  border: none;
  line-height: 1.5;
  display: block;
  color: var(--color-text);
  quotes: none !important; /* specific for blockquote */
}

.quote-author {
  display: block;
  font-size: 14px;
  font-style: normal;
  font-weight: 500;
  color: var(--color-meta);
  margin-bottom: 8px;
}

.quote-translation {
  font-size: 14px;
  font-style: normal;
  margin-top: 12px;
  padding-top: 8px;
  border-top: 1px solid var(--color-border);
  color: var(--color-text);
  opacity: 0.8;
}

.quote-btn {
  background: transparent;
  color: var(--color-accent-1);
  border: 1px solid var(--color-accent-1);
  padding: 8px 16px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
  transition: all 0.2s;
}

.quote-btn:hover {
  background: var(--color-accent-1);
  color: var(--color-background);
  transform: translateY(-1px);
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const quotes = [
    {{ range $quotes }}
      {
        text: {{ .text | jsonify }},
        author: {{ .author | jsonify }}{{ if .translation }},
        translation: {{ .translation | jsonify }}{{ end }}
      },
    {{ end }}
  ];

  let currentIndex = {{ mod now.Unix (len $quotes) }};

  function displayQuote(quote) {
      const container = document.querySelector('.quote-content');

      // --- FIX: Aggressively strip quotes from the start and end of string ---
      // This regex removes: " or ' or “ or ” or ‘ or ’ or whitespace
      let cleanText = quote.text.replace(/^["'“‘\s]+|["'”’\s]+$/g, '');

      const formattedText = cleanText.replace(/--/g, '<br>');
      const formattedTranslation = quote.translation ? quote.translation.replace(/--/g, '<br>') : '';

      const translationHtml = quote.translation ?
            `<div class="translation">${formattedTranslation}</div>` : '';

      container.innerHTML = `
    <blockquote class="quote-text">${formattedText}</blockquote>
    <cite class="quote-author">— ${quote.author}</cite>
    ${translationHtml}
  `;
  }

  document.getElementById('next-quote').addEventListener('click', function() {
    currentIndex = (currentIndex + 1) % quotes.length;
    displayQuote(quotes[currentIndex]);
  });
  document.getElementById('prev-quote').addEventListener('click', function() {
      currentIndex = (currentIndex - 1 + quotes.length) % quotes.length;
      displayQuote(quotes[currentIndex]);
  });
});
</script>
